<?php

require __DIR__ . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\IOFactory;
use PhpOffice\PhpSpreadsheet\Cell\Coordinate;
if (isset($_POST['submit'])) {
    // Database connection details
    $dbHost = 'localhost';
    $dbName = 'paymentdetails';
    $dbUser = 'root';
    $dbPassword = '';
    
    // Connect to the database
    $conn = new mysqli($dbHost, $dbUser, $dbPassword, $dbName);
    if ($conn->connect_error) {
        die('Connection failed: ' . $conn->connect_error);
    }
    
    // File upload handling
    if ($_FILES['file']['error'] === UPLOAD_ERR_OK) {
        $uploadedFile = $_FILES['file']['tmp_name'];
        // Load the uploaded CSV file
        try {

            $spreadsheet = IOFactory::load($uploadedFile);
            // Rest of the code
        } catch (Exception $e) {
            echo 'Error loading file: ',  $e->getMessage(), "\n";
        }
        
        // $spreadsheet = IOFactory::load($uploadedFile);

        // Select the first worksheet
        $worksheet = $spreadsheet->getActiveSheet();

        // Get the highest column and row numbers referenced in the worksheet
        $lastColumn = $worksheet->getHighestColumn();
        $highestColumn = Coordinate::columnIndexFromString($lastColumn);
        $highestRow = $worksheet->getHighestRow();

        // Assuming the first row contains column names
        $columns = [];
        for ($col = 1; $col <= $highestColumn; ++$col) {
            $columns[] = $worksheet->getCellByColumnAndRow($col, 1)->getValue();
        }

        // Loop through each row of the worksheet starting from row 2 (assuming row 1 has column names)
        for ($row = 1; $row <= $highestRow; ++$row) {
            if ($row === 1) {
                continue;
            }
            // Prepare data
            $data = [];
            for ($col = 1; $col <= $highestColumn; ++$col) {
                $data[$columns[$col - 1]] = $worksheet->getCellByColumnAndRow($col, $row)->getValue();
            }

            // Create SQL query
            $sql = "INSERT INTO studentdetails(";
            $sql .= join(', ', array_map(function ($column) {
                return "`$column`"; // Use backticks to ensure correct escaping of column names
            }, $columns)) . ") VALUES (";
            $sql .= join(', ', array_map(function ($value) use ($conn) {
                return "'" . $conn->real_escape_string($value) . "'";
            }, array_values($data))) . ")";
            // Execute the query
        if ($conn->query($sql) === TRUE) {
            $success_message =  "Data inserted successfully";
            header("Location: file.html#?success_message=" . urlencode($success_message));
        } else {
            echo "Error: " . $conn->error . "\n";
        }
            
        }
        
        // Close the database connection
        $conn->close();
    } else {
        echo "File upload failed with error code: " . $_FILES['file']['error'];
    }
}

?>


<?php
    // Enable error reporting for debugging
    error_reporting(E_ALL);
    ini_set('display_errors', 1);

    // Require the database configuration file
    require 'config.php';


if ($_SERVER["REQUEST_METHOD"] == "POST") {
    // Fetch values from the submitted form
    $TuitionFee = $_POST['TuitionFee'];
    $SpecialFee = $_POST["SpecialFee"];
    $UCSFees = $_POST["UCSFees"];
    $yearSelection = $_POST["yearSelection"];

    try {
        // Retrieve the existing fee details for the previous year
        $previousYear = $yearSelection - 1; // Assuming the years are consecutive
        $selectPreviousYearSQL = "SELECT * FROM studentdetails WHERE `Year` = '$previousYear'";
        $result = $conn->query($selectPreviousYearSQL);

        // Fetch previous year's fee details
        $previousFees = [];
        if ($result->num_rows > 0) {
            $row = $result->fetch_assoc();
            $previousFees['Tution_fee'] = $row['Tution_fee'];
            $previousFees['Special_fee'] = $row['Special_fee'];
            $previousFees['UCS_fee'] = $row['UCS_fee'];
        }

        // Prepare and execute the SQL query to update fee details for the selected year
        $sql = "UPDATE studentdetails 
                SET `Tution_fee` = '$TuitionFee', 
                    `Special_fee` = '$SpecialFee', 
                    `UCS_fee` = '$UCSFees'
                WHERE `Year` = '$yearSelection'";

        // Execute the SQL query and handle success or error
        if ($conn->query($sql) === TRUE) {
            // On successful update, redirect with success message
            $success_message = "Fees updated successfully for year $yearSelection";
            header("Location: ../file.html#?success_message=" . urlencode($success_message));
        } else {
            // Display error message if the query fails
            echo "Error: " . $sql . "<br>" . $conn->error;
        }
    } catch (Exception $e) {
        // Handle exceptions, redirect with error message
        $privio = "An error occurred while updating records";
        header("Location: ../file.html#?privio=" . urlencode($privio));
    }

    // Close the database connection
    $conn->close();
}

    // Check if the form is submitted via POST method
    // if ($_SERVER["REQUEST_METHOD"] == "POST") {
    //     // Fetch values from the submitted form
    //     $AdmissionFee = $_POST["AdmissionFee"];
    //     $TuitionFee = $_POST['TuitionFee'];
    //     $SpecialFee = $_POST["SpecialFee"];
    //     $UCSFees = $_POST["UCSFees"];
    //     $yearSelection = $_POST["yearSelection"];

    //     try {
    //         // Prepare and execute the SQL query to update fee details for a specific year
    //         $sql = "UPDATE studentdetails 
    //                 SET `Admission_Fees` = '$AdmissionFee', 
    //                     `Tution_fee` = '$TuitionFee', 
    //                     `Special_fee` = '$SpecialFee', 
    //                     `UCS_fee` = '$UCSFees'
    //                 WHERE `Year` = '$yearSelection'";

    //         // Execute the SQL query and handle success or error
    //         if ($conn->query($sql) === TRUE) {
    //             // On successful update, redirect with success message
    //             $success_message = "Fees updated successfully for year $yearSelection";
    //             header("Location: ../file.html#?success_message=" . urlencode($success_message));
    //         } else {
    //             // Display error message if the query fails
    //             echo "Error: " . $sql . "<br>" . $conn->error;
    //         }
    //     } catch (Exception $e) {
    //         // Handle exceptions, redirect with error message
    //         $privio = "An error occurred while updating records";
    //         header("Location: ../file.html#?privio=" . urlencode($privio));
    //     }

    //     // Close the database connection
    //     $conn->close();
    // }
?>
